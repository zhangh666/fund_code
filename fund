import akshare as ak
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from datetime import datetime, timedelta
import concurrent.futures
import multiprocessing
import time
from openpyxl.utils import get_column_letter
plt.rcParams['font.sans-serif'] = ['SimHei']  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾
plt.rcParams['axes.unicode_minus'] = False  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·

themes = ["ç™½é…’", "é»„é‡‘", "äººå·¥æ™ºèƒ½", "æœºå™¨äºº", "åŠå¯¼ä½“", "åŒ»è¯"]

# ç”¨æˆ·æŒ‡å®šçš„åŸºé‡‘ä»£ç å’Œåç§°
specific_funds = [
    {"code": "018124", "name": "æ°¸èµ¢å…ˆè¿›åˆ¶é€ æ™ºé€‰æ··åˆå‘èµ·A"}
]

results = {}
history_results = {}

# è·å–æ‰€æœ‰å¼€æ”¾å¼åŸºé‡‘æ’è¡Œ
df_funds = ak.fund_open_fund_rank_em(symbol="å…¨éƒ¨")

for theme in themes:
    # åœ¨åŸºé‡‘åç§°ä¸­æœç´¢ä¸»é¢˜å…³é”®è¯
    theme_match = df_funds[df_funds["åŸºé‡‘ç®€ç§°"].str.contains(theme, na=False)]
    
    results[theme] = {
        "ç›¸å…³åŸºé‡‘": theme_match[["åŸºé‡‘ä»£ç ", "åŸºé‡‘ç®€ç§°", "å•ä½å‡€å€¼", "æ—¥å¢é•¿ç‡", "è¿‘1å‘¨", "è¿‘1æœˆ", "è¿‘3æœˆ", "è¿‘6æœˆ", "ä»Šå¹´æ¥", "è¿‘1å¹´", "è¿‘2å¹´", "è¿‘3å¹´"]]
    }
    
    # è·å–å†å²æ•°æ®ï¼ˆå–ç¬¬ä¸€åªåŸºé‡‘ä½œä¸ºç¤ºä¾‹ï¼‰
    if not theme_match.empty:
        fund_code = theme_match.iloc[0]["åŸºé‡‘ä»£ç "]
        # è·å–è¿‡å»12ä¸ªæœˆçš„æ•°æ®
        end_date = datetime.now().strftime("%Y%m%d")
        start_date = (datetime.now() - timedelta(days=365)).strftime("%Y%m%d")
        
        try:
            # å°è¯•è·å–ETFå†å²æ•°æ®
            hist_data = ak.fund_etf_hist_em(symbol=fund_code, period='monthly', 
                                          start_date=start_date, end_date=end_date)
        except:
            try:
                # å¦‚æœETFæ•°æ®è·å–å¤±è´¥ï¼Œå°è¯•LOFå†å²æ•°æ®
                hist_data = ak.fund_lof_hist_em(symbol=fund_code, period='monthly',
                                               start_date=start_date, end_date=end_date)
            except:
                hist_data = pd.DataFrame()
        
        history_results[theme] = hist_data

# æ‰“å°å„ä¸»é¢˜åŸºé‡‘ä¿¡æ¯
for theme, data in results.items():
    print(f"\n===== {theme} åŸºé‡‘ =====")
    if not data["ç›¸å…³åŸºé‡‘"].empty:
        print("ç›¸å…³åŸºé‡‘ï¼š")
        print(data["ç›¸å…³åŸºé‡‘"].head(10))
    else:
        print("æœªæ‰¾åˆ°ç›¸å…³åŸºé‡‘")

# åŸºé‡‘æ•°æ®ç¼“å­˜ï¼ˆé¿å…é‡å¤è¯·æ±‚ç›¸åŒåŸºé‡‘ï¼‰
fund_data_cache = {}

# å¸¦é‡è¯•æœºåˆ¶çš„åŸºé‡‘æ•°æ®è·å–
def get_fund_history_data_with_retry(fund_code, days=7, max_retries=3):
    """è·å–åŸºé‡‘å†å²æ•°æ®ï¼ˆå¸¦ç¼“å­˜å’Œé‡è¯•åŠŸèƒ½ï¼‰"""
    # æ£€æŸ¥ç¼“å­˜
    cache_key = f"{fund_code}_{days}"
    if cache_key in fund_data_cache:
        return fund_data_cache[cache_key].copy()
    
    end_date = datetime.now().strftime("%Y%m%d")
    start_date = (datetime.now() - timedelta(days=days)).strftime("%Y%m%d")
    
    # é‡è¯•æœºåˆ¶
    for attempt in range(max_retries):
        try:
            # é¦–å…ˆå°è¯•å¼€æ”¾å¼åŸºé‡‘æ•°æ®æ¥å£ï¼ˆé€‚ç”¨äºæ··åˆå‹åŸºé‡‘ï¼‰
            hist_data = ak.fund_open_fund_info_em(symbol=fund_code, indicator="å•ä½å‡€å€¼èµ°åŠ¿")
            if not hist_data.empty:
                # é‡å‘½ååˆ—ä»¥ç»Ÿä¸€æ ¼å¼
                hist_data = hist_data.rename(columns={'å‡€å€¼æ—¥æœŸ': 'æ—¥æœŸ', 'å•ä½å‡€å€¼': 'æ”¶ç›˜'})
                # è¿‡æ»¤æœ€è¿‘dayså¤©çš„æ•°æ®
                hist_data['æ—¥æœŸ'] = pd.to_datetime(hist_data['æ—¥æœŸ'])
                hist_data = hist_data[hist_data['æ—¥æœŸ'] >= pd.to_datetime(start_date)]
                # ç¼“å­˜ç»“æœ
                fund_data_cache[cache_key] = hist_data.copy()
                return hist_data
        except Exception as e:
            if attempt == max_retries - 1:
                print(f"è­¦å‘Š: è·å–åŸºé‡‘ {fund_code} æ•°æ®å¤±è´¥: {str(e)}")
            continue
        
        try:
            # å¦‚æœå¼€æ”¾å¼åŸºé‡‘æ¥å£å¤±è´¥ï¼Œå°è¯•ETFæ¥å£
            hist_data = ak.fund_etf_hist_em(symbol=fund_code, period='daily', 
                                          start_date=start_date, end_date=end_date)
            if not hist_data.empty:
                # ç¡®ä¿æ—¥æœŸåˆ—ä¸ºdatetimeç±»å‹
                if 'æ—¥æœŸ' in hist_data.columns:
                    hist_data['æ—¥æœŸ'] = pd.to_datetime(hist_data['æ—¥æœŸ'])
                # ç¼“å­˜ç»“æœ
                fund_data_cache[cache_key] = hist_data.copy()
                return hist_data
        except Exception as e:
            if attempt == max_retries - 1:
                print(f"è­¦å‘Š: è·å–åŸºé‡‘ {fund_code} ETFæ•°æ®å¤±è´¥: {str(e)}")
            continue
        
        try:
            # æœ€åå°è¯•LOFæ¥å£
            hist_data = ak.fund_lof_hist_em(symbol=fund_code, period='daily',
                                           start_date=start_date, end_date=end_date)
            if not hist_data.empty:
                # ç¡®ä¿æ—¥æœŸåˆ—ä¸ºdatetimeç±»å‹
                if 'æ—¥æœŸ' in hist_data.columns:
                    hist_data['æ—¥æœŸ'] = pd.to_datetime(hist_data['æ—¥æœŸ'])
                # ç¼“å­˜ç»“æœ
                fund_data_cache[cache_key] = hist_data.copy()
                return hist_data
        except Exception as e:
            if attempt == max_retries - 1:
                print(f"è­¦å‘Š: è·å–åŸºé‡‘ {fund_code} LOFæ•°æ®å¤±è´¥: {str(e)}")
            continue
    
    # ç¼“å­˜ç©ºç»“æœä»¥é¿å…é‡å¤è¯·æ±‚
    fund_data_cache[cache_key] = pd.DataFrame()
    return pd.DataFrame()

# è·å–å•ä¸ªåŸºé‡‘çš„å†å²æ•°æ®
def get_fund_history_data(fund_code, days=7):
    """è·å–åŸºé‡‘å†å²æ•°æ®ï¼ˆå¸¦ç¼“å­˜åŠŸèƒ½ï¼‰"""
    return get_fund_history_data_with_retry(fund_code, days)

# ç”Ÿæˆå‘¨åº¦æ•°æ®æŠ¥å‘Š
def generate_weekly_report(results):
    """ç”Ÿæˆå‘¨åº¦æ•°æ®æŠ¥å‘Š"""
    print("ğŸ“Š åŸºé‡‘å‘¨åº¦æ¶¨è·Œæ•°æ®æŠ¥å‘Š")
    print("=" * 50)
    
    for theme, data in results.items():
        if not data["ç›¸å…³åŸºé‡‘"].empty:
            print(f"\nğŸ¯ {theme}ä¸»é¢˜åŸºé‡‘")
            print("-" * 30)
            
            # æ˜¾ç¤ºå‰5åªåŸºé‡‘çš„å‘¨åº¦æ•°æ®
            weekly_data = data["ç›¸å…³åŸºé‡‘"].head(5)[["åŸºé‡‘ç®€ç§°", "è¿‘1å‘¨", "å•ä½å‡€å€¼"]]
            for _, fund in weekly_data.iterrows():
                trend = "ğŸ“ˆ" if fund["è¿‘1å‘¨"] >= 0 else "ğŸ“‰"
                print(f"{trend} {fund['åŸºé‡‘ç®€ç§°']:20} å‘¨æ¶¨è·Œ: {fund['è¿‘1å‘¨']:6.2f}%  å‡€å€¼: {fund['å•ä½å‡€å€¼']:.3f}")
    
    print(f"\nâ° æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M')}")

# å¯¼å‡ºåŸºé‡‘æ•°æ®åˆ°Excelè¡¨æ ¼
def export_fund_data_to_excel(results, specific_funds):
    """å¯¼å‡ºåŸºé‡‘æ•°æ®åˆ°Excelè¡¨æ ¼"""
    current_date = datetime.now().strftime('%m%d')
    filename = f"{current_date}_åŸºé‡‘æ•°æ®.xlsx"
    
    # è®°å½•å¼€å§‹æ—¶é—´
    start_time = time.time()
    
    # ç”Ÿæˆæœ€è¿‘ä¸€å‘¨çš„æ—¥æœŸåˆ—è¡¨ï¼ˆä»6å¤©å‰åˆ°ä»Šå¤©ï¼Œå…±7å¤©ï¼‰
    date_list = []
    for i in range(6, -1, -1):
        date = (datetime.now() - timedelta(days=i)).strftime('%m.%d')
        date_list.append(date)
    
    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        # å¯¼å‡ºå„ä¸»é¢˜åŸºé‡‘æ•°æ®
        for theme, data in results.items():
            if not data["ç›¸å…³åŸºé‡‘"].empty:
                # è·å–è¯¥ä¸»é¢˜ä¸‹æ‰€æœ‰åŸºé‡‘çš„æ¯æ—¥å¢é•¿ç‡æ•°æ®
                theme_daily_data = []
                
                # ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œè·å–åŸºé‡‘å†å²æ•°æ®
                fund_codes = []
                fund_names = []
                fund_navs = []
                
                for _, fund in data["ç›¸å…³åŸºé‡‘"].iterrows():
                    fund_codes.append(fund["åŸºé‡‘ä»£ç "])
                    fund_names.append(fund["åŸºé‡‘ç®€ç§°"])
                    fund_navs.append(fund['å•ä½å‡€å€¼'])
                
                # å¹¶è¡Œè·å–æ‰€æœ‰åŸºé‡‘çš„å†å²æ•°æ®ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°ï¼‰
                max_workers = min(len(fund_codes), multiprocessing.cpu_count() * 2)
                with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
                    hist_data_list = list(executor.map(get_fund_history_data, fund_codes, [7]*len(fund_codes)))
                
                # å¤„ç†è·å–åˆ°çš„å†å²æ•°æ®
                for i, hist_data in enumerate(hist_data_list):
                    if not hist_data.empty:
                        # è®¡ç®—æ¯æ—¥å¢é•¿ç‡
                        hist_data = hist_data.sort_values('æ—¥æœŸ')
                        hist_data['å¢é•¿ç‡'] = hist_data['æ”¶ç›˜'].pct_change() * 100
                        
                        # åˆ›å»ºæ¯æ—¥å¢é•¿ç‡æ•°æ®è¡Œ
                        daily_row = {
                            'åŸºé‡‘ä»£ç ': fund_codes[i],
                            'åŸºé‡‘åç§°': fund_names[i],
                            'å•ä½å‡€å€¼': fund_navs[i]
                        }
                        
                        # å¡«å……æ¯æ—¥å¢é•¿ç‡æ•°æ®
                        for date_str in date_list:
                            # ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…æ—¥æœŸæ ¼å¼
                            matching_data = hist_data[hist_data['æ—¥æœŸ'].dt.strftime('%m.%d') == date_str]
                            
                            if not matching_data.empty:
                                # è®¾ç½®ç™¾åˆ†æ¯”æ ¼å¼ï¼Œä¿ç•™ä¸¤ä½å°æ•°
                                growth_rate = matching_data['å¢é•¿ç‡'].iloc[0]
                                if pd.notna(growth_rate):
                                    daily_row[date_str] = f"{growth_rate:.2f}%"
                                else:
                                    daily_row[date_str] = "-"  # ç”¨"-"ä»£æ›¿None
                            else:
                                daily_row[date_str] = "-"  # ç”¨"-"ä»£æ›¿None
                        
                        theme_daily_data.append(daily_row)
                
                if theme_daily_data:
                    # åˆ›å»ºDataFrameå¹¶å¯¼å‡ºåˆ°Excel
                    daily_df = pd.DataFrame(theme_daily_data)
                    daily_df.to_excel(writer, sheet_name=theme[:30], index=False)
                    
                    # ç®€åŒ–åˆ—å®½è°ƒæ•´ï¼ˆä»…è°ƒæ•´å‰å‡ åˆ—ï¼Œé¿å…æ€§èƒ½å¼€é”€ï¼‰
                    worksheet = writer.sheets[theme[:30]]
                    worksheet.column_dimensions['A'].width = 10  # åŸºé‡‘ä»£ç 
                    worksheet.column_dimensions['B'].width = 44  # åŸºé‡‘åç§°
                    for col in ['C', 'D', 'E', 'F', 'G', 'H']:  # æ—¥æœŸåˆ—
                        worksheet.column_dimensions[col].width = 12
        
        # å¯¼å‡ºæŒ‡å®šåŸºé‡‘çš„è¯¦ç»†å†å²æ•°æ®
        if specific_funds:
            detailed_data = []
            fund_codes = [fund['code'] for fund in specific_funds]
            fund_names = [fund['name'] for fund in specific_funds]
            
            # å¹¶è¡Œè·å–æ‰€æœ‰åŸºé‡‘çš„å†å²æ•°æ®ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°ï¼‰
            max_workers = min(len(fund_codes), multiprocessing.cpu_count() * 2)
            with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
                fund_data_list = list(executor.map(get_fund_history_data, fund_codes, [7]*len(fund_codes)))
            
            # å¤„ç†è·å–åˆ°çš„å†å²æ•°æ®
            for i, fund_data in enumerate(fund_data_list):
                if not fund_data.empty:
                    # æ·»åŠ åŸºé‡‘ä»£ç å’Œåç§°åˆ—
                    fund_data['åŸºé‡‘ä»£ç '] = fund_codes[i]
                    fund_data['åŸºé‡‘åç§°'] = fund_names[i]
                    detailed_data.append(fund_data)
            
            if detailed_data:
                combined_data = pd.concat(detailed_data, ignore_index=True)
                combined_data.to_excel(writer, sheet_name="è¯¦ç»†å†å²æ•°æ®", index=False)
                
                # ç®€åŒ–åˆ—å®½è°ƒæ•´ï¼ˆä»…è°ƒæ•´å‰å‡ åˆ—ï¼Œé¿å…æ€§èƒ½å¼€é”€ï¼‰
                worksheet = writer.sheets["è¯¦ç»†å†å²æ•°æ®"]
                worksheet.column_dimensions['A'].width = 10  # åŸºé‡‘ä»£ç 
                worksheet.column_dimensions['B'].width = 44  # åŸºé‡‘åç§°
                for col in ['C', 'D', 'E', 'F', 'G', 'H']:  # æ—¥æœŸåˆ—
                    worksheet.column_dimensions[col].width = 12
    
    # è®¡ç®—å¹¶æ˜¾ç¤ºå¯¼å‡ºæ—¶é—´
    export_time = time.time() - start_time
    print(f"ğŸ“Š åŸºé‡‘æ•°æ®å·²å¯¼å‡ºåˆ°: {filename}")
    print(f"â±ï¸  å¯¼å‡ºè€—æ—¶: {export_time:.2f} ç§’")
    return filename

# ä¸»æ‰§è¡Œå‡½æ•°
def main():
    """ä¸»æ‰§è¡Œå‡½æ•°"""
    print("ğŸš€ å¼€å§‹è·å–åŸºé‡‘æ•°æ®...")
    
    # åŸæœ‰çš„æ•°æ®è·å–å’Œå¯è§†åŒ–ä»£ç 
    # ...
    
    # ç”Ÿæˆå‘¨åº¦æ•°æ®æŠ¥å‘Š
    generate_weekly_report(results)
    
    # å¯¼å‡ºåŸºé‡‘æ•°æ®åˆ°Excelè¡¨æ ¼
    print("\n" + "="*60)
    print("ğŸ’¾ å¼€å§‹å¯¼å‡ºåŸºé‡‘æ•°æ®åˆ°Excelè¡¨æ ¼...")
    print("="*60)
    export_fund_data_to_excel(results, specific_funds)
    
    print("\nâœ… æ‰€æœ‰æ•°æ®æŠ¥å‘Šç”Ÿæˆå®Œæˆ")

if __name__ == "__main__":
    main()
